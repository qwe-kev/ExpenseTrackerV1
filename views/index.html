<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700&display=swap" rel="stylesheet">

	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="/css/expList.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.2.3/axios.min.js"></script>
  </head>
  <style>
    body{
        background-image: url('https://www.psohub.com/hubfs/Blog%20visuals/12_Make-Time-%26-Expense-Reporting-Suck-Less_541x290.png');
        background-size: cover;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
       
    }
    form, input, label {
    color: #000 !important;
    }
  </style>
<body>
  <nav class="navbar navbar-light" style="background-color: #e3f2fd; background:transparent;">
    <div class="navbar-header" style="float: left; padding: 8px; text-align: center; width: 100%;">
      <a class="navbar-brand" href="#" style="float:none;">
        <i class="fa-solid fa-sack-dollar"></i>
        Expense Tracker
      </a>
    </div>
  </nav>
  <br>
      <div class="container-fluid m-auto img-fluid ps-5" style="
    /* background-image: url('https://cdn1.vectorstock.com/i/1000x1000/56/85/icon-design-budgets-to-save-expenses-pay-vector-37825685.jpg'); */
      height: 100vh;
    ">
        <div class="msg"></div>
        <form class="form-inline" id="my-form" method="post">
            <div class="row">
                <div class="col-auto">
                    <label class="colFormLabelSm" for="expAmount">Amount</label>
                  <input type="number" id="expAmount" class="form-control-sm" placeholder="0" aria-label="Expense amount">
                </div>
                <div class="col-auto">
                    <label class="colFormLabelSm" for="expDescription">Description</label>
                  <input type="text" id="expDescription" class="form-control-sm" placeholder="description" aria-label="description">
                </div>
                <div class="col-auto">
                    <label class="colFormLabelSm" for="expCategory">Category</label>
                    <select class="form-control-sm" id="expCategory" name="" id="">
                        <option value="food">food</option>
                        <option value="fuel">fuel</option>
                        <option value="movie">movie</option>
                        <option value="shopping">shopping</option>
                    </select>
                </div>
                <div class="col">
                    <button type="submit" id="Button" class="btn btn-dark btn-sm">Submit</button>
                </div>
              </div>
        </form>
       <br>
  <div class="container opacity-75">

    <div class="listWrap">
    
        <ul class="expList">
        
            <li>
                <span>Amount</span>
                <span>Description</span>
                <span>Category</span>
                <span>Actions</span>
                <span></span>
            </li>
           
        </ul>

    </div>

</div>
<script>
   const myForm = document.querySelector('#my-form');
  const expAmt = document.querySelector("#expAmount");
  const expDesc = document.querySelector("#expDescription");
  const expCat = document.querySelector("#expCategory");
  const message = document.querySelector(".msg");
  const expList = document.querySelector(".expList");
  const buttonSubmit = document.querySelector("#Button");
  let expenses = 
  [
    {
        "id": 18,
        "amount": 1000,
        "description": "cookies",
        "category": "food",
        "createdAt": "2023-01-26T18:40:24.000Z",
        "updatedAt": "2023-01-26T18:40:24.000Z"
    },
    {
        "id": 19,
        "amount": 8000,
        "description": "electronics",
        "category": "shopping",
        "createdAt": "2023-01-26T18:40:24.000Z",
        "updatedAt": "2023-01-26T18:40:24.000Z"
    }
]
expList.addEventListener('click', (e) => {
  const span = e.target.parentElement.parentElement.parentElement.getElementsByTagName('span')[1];
  console.log(span.textContent)
})
async function getExpenses(e) {
    try {
     const res = await axios.get('http://localhost:3000/expenses/getExpenses');
     console.log("res",res.data)
      res.data.forEach(expense => {
            const {amount, description, category} = expense;
            const li = document.createElement("li");
            //li.classList.add("list-group-item-warning")
            const amountSpan = document.createElement("span");
            const descriptionSpan = document.createElement("span");
            const categorySpan = document.createElement("span");

            const buttonSpan = document.createElement("span");

            const buttonDiv = document.createElement("div");
            buttonDiv.classList.add("btn-group","btn-group-xs");
            buttonDiv.setAttribute('role', 'group');
            buttonDiv.setAttribute('aria-label', '...');

            const amountText = document.createTextNode(`${amount}`);
            const descriptionText = document.createTextNode(`${description}`);
            const categoryText= document.createTextNode(`${category}`);


            const deleteBtn = document.createElement("button");
            const editBtn = document.createElement("button");

            deleteBtn.classList.add('btn','btn-sm','btn-default','btn-outline-dark','delete');
            editBtn.classList.add('btn','btn-sm','btn-default','btn-outline-dark','edit');

            deleteBtn.classList.add('delete');
            editBtn.classList.add('edit');
            editBtn.innerHTML = "Edit";
            deleteBtn.innerHTML = "Delete"

            buttonDiv.appendChild(editBtn);
            buttonDiv.appendChild(deleteBtn);

            buttonSpan.appendChild(buttonDiv);

            amountSpan.appendChild(amountText);
            descriptionSpan.appendChild(descriptionText);
            categorySpan.appendChild(categoryText);
            
            li.appendChild(amountSpan);
            li.appendChild(descriptionSpan);
            li.appendChild(categorySpan);

            li.appendChild(buttonSpan);
            li.appendChild(document.createElement('span'));
            expList.appendChild(li);
        });
    }
    catch(err) {
      console.log(err);
    }
  }

  async function addExpense(e) {
        try{
            e.preventDefault();
            if(expAmt.value === "" || expDesc.value === "" || expCat.value === "") {
                message.classList.add("bg-warning");
                message.innerHTML = "please enter all fields";
                setTimeout(() => message.remove(), 1000);
            }
            else{
                let expItem = {
                    amount : expAmt.value,
                    description : expDesc.value,
                    category : expCat.value
                }
                const res = await axios.post(`http://localhost:3000/expenses/addExpense`,expItem);
                console.log(res.data)
                window.location.reload();
            }
        }
        catch(err) {
            if(error.response) {
                console.log(error.response.status);
                console.log(error.response.headers);
            }
            else if(error.request) {
                console.log(error.request);
            }
            else{
                console.log({'Error' : error.message});
            }
        }    
    }

  async function deleteExpense(e) {
    try {
        e.preventDefault();
        let id;
        if(e.target.classList && e.target.classList.contains('delete')){
          console.log("delete button");
            let li = e.target.parentNode.parentNode.parentNode;
            const expenseSelected = [li.childNodes[0].textContent,li.childNodes[1].textContent,li.childNodes[2].textContent]
            const readExp = await axios.get(`http://localhost:3000/expenses/getExpenses`);
            readExp.data.forEach(expense => {
                if(expense.amount === +expenseSelected[0] && expense.description === expenseSelected[1] && expense.category === expenseSelected[2]) {
                    id = expense.id;
                }
            }) 
        }
        console.log("id", id)
        const res = await axios.get(`http://localhost:3000/expenses/deleteExpense`,{
          params : {
            id : id
          }
        });
        console.log("deleted expense",res);
        window.location.reload();
    }
    catch(error) {
        if(error.response) {
            console.log(error.response.status);
            console.log(error.response.headers);
        }
        else if(error.request) {
            console.log(error.request);
        }
        else{
            console.log({'Error' : error.message});
        }
    }
}

var id;

  async function editExpense(e, expItem, id) {
    try{
        e.preventDefault();
        const editRes = await axios.get(`http://localhost:3000/expenses/editExpense`, {
          params : {
            id : id,
            expenseItem : expItem
          }
        });
        console.log("edited item");
        window.location.reload();
    }
    catch(error) {
        if(error.response) {
            console.log(error.response.status);
            console.log(error.response.headers);
        }
        else if(error.request) {
            console.log(error.request);
        }
        else{
            console.log({'Error' : error.message});
        }  
    }
}

expList.addEventListener('click', async (e) => {
    console.log(e.target)
    if(e.target.classList && e.target.classList.contains('delete')){
        deleteExpense(e);
    }
    else {
        e.preventDefault();
        let button = document.querySelector("#Button");
        button.innerHTML = "update";
        let li = e.target.parentNode.parentNode.parentNode;
        const expenseSelected = [li.childNodes[0].textContent,li.childNodes[1].textContent,li.childNodes[2].textContent]
        const [amount, description, category] = expenseSelected;
        document.querySelector("#expAmount").setAttribute('value', amount);
        document.querySelector("#expDescription").setAttribute('value', description);
        document.querySelector("#expCategory").setAttribute('value', category);
       // li = e.target.parentNode.firstChild.wholeText.split('-');
        const readExp = await axios.get(`http://localhost:3000/expenses/getExpenses`);
        readExp.data.forEach(expense => {
            if(expense.amount === +expenseSelected[0] && expense.description === expenseSelected[1] && expense.category === expenseSelected[2]) {
                id = expense.id;
            }
        }) 
        console.log("edit id", id)
    }
});

  document.addEventListener('DOMContentLoaded',getExpenses);
  var expenseId, expItem;

  myForm.addEventListener('click', (e) => {
    if(e.target.innerHTML === "Submit") {
       addExpense(e);
    }
    else if(e.target.innerHTML === "update") {
        expItem = {
            amount : document.querySelector("#expAmount").value,
            description : document.querySelector("#expDescription").value,
            category : document.querySelector("#expCategory").value
        }
        console.log(expItem, id);
        editExpense(e, expItem, id);
    }
});
</script>

</body>
</html>